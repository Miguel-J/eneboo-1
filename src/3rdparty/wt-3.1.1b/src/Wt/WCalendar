// This may look like C code, but it's really -*- C++ -*-
/*
 * Copyright (C) 2008 Emweb bvba, Kessel-Lo, Belgium.
 *
 * See the LICENSE file for terms of use.
 */
#ifndef WCALENDAR_H_
#define WCALENDAR_H_

#include <Wt/WCompositeWidget>
#include <Wt/WDate>
#include <Wt/WSignalMapper>
#include <set>

namespace boost {
  namespace gregorian {
    class date;
  }
}

namespace Wt {

class WComboBox;
class WInPlaceEdit;
class WTemplate;

/*! \class WCalendar Wt/WCalendar Wt/WCalendar
 *  \brief A calendar.
 *
 * The calendar provides navigation by month and year, and indicates the
 * current day.
 *
 * The calendar may be configured to allow selection of single or
 * multiple days, and you may listen for changes in the selection
 * using the selectionChanged() or selected() signals.
 *
 * Internationalization may be provided by indicating i18n == true in
 * the constructor, and providing the appropriate messages for months
 * (with keys from WDate::longMonthName()) and days (with keys from
 * WDate::shortDayName()) in your message resource bundle.
 *
 * \if cpp
 * Usage example:
 * \code
 * Wt::WDate today = Wt::WDate::currentDate();
 *
 * Wt::WCalendar *calendar = new Wt::WCalendar(this);
 * calendar->browseTo(today.addMonths(1));
 * calendar->select(today.addMonths(1).addDays(3));
 * calendar->selected().connect(SLOT(this, MyWidget::daySelected));
 * \endcode
 * \endif
 *
 * Here is a snapshot, taken on 19/01/2010 (shown as
 * today), and 14/01/2010 currently selected.
 * <TABLE border="0" align="center"> <TR> <TD> 
 * \image html WCalendar-default-1.png "WCalendar with default look" 
 * </TD> <TD> 
 * \image html WCalendar-polished-1.png "WCalendar with polished look" 
 * </TD> </TR> </TABLE>
 *
 * <h3>CSS</h3>
 *
 * The calendar is styled by the current CSS theme. The look can be
 * overridden using the <tt>Wt-calendar</tt> CSS class and the following
 * selectors:
 *
 * \verbatim
.Wt-cal table    : The table
.Wt-cal table.d1 : The table (single letter day headers)
.Wt-cal table.d3 : The table (three letter day headers)

.Wt-cal caption	 : The caption (containing the navigation buttons)
.Wt-cal-year	 : The caption year in-place-edit

.Wt-cal th       : Header cell (week day)

.Wt-cal td       : Day cell
.Wt-cal-oom      : Out-of-month day
.Wt-cal-sel      : Selected day
.Wt-cal-now      : Today day
\endverbatim
 *
 */
class WT_API WCalendar : public WCompositeWidget
{
public:
  /*! \brief Creates a new calendar.
   *
   * Constructs a new calendar with English day/month names.  The
   * calendar shows the current day, and has an empty selection.
   */
  WCalendar(WContainerWidget *parent = 0);

  /*! \brief Creates a new calendar.
   *
   * Constructs a new calendar, with optional support for internationalization.
   * The calendar shows the current day, and has an empty selection.
   */
  WCalendar(bool i18n, WContainerWidget *parent = 0);

  /*! \brief Configures single or multiple selection mode.
   *
   * In single selection mode, only one date may be selected: the selection()
   * will be empty or contain exactly one item. 
   */
  void setMultipleSelection(bool multiple);

  /*! \brief Browses to the same month in the previous year.
   *
   * Displays the same month in the previous year. This does not change
   * the current selection.
   */
  void browseToPreviousYear();

  /*! \brief Browses to the previous month.
   *
   * Displays the previous month. This does not change the current selection.
   */
  void browseToPreviousMonth();

  /*! \brief Browses to the same month in the next year.
   *
   * Displays the same month in the next year. This does not change
   * the current selection.
   */
  void browseToNextYear();

  /*! \brief Browses to the next month.
   *
   * Displays the next month. This does not change the current selection.
   */
  void browseToNextMonth();

  /*! \brief Browses to a date.
   *
   * Displays the month which contains the given date. This does not change
   * the current selection.
   */
  void browseTo(const WDate& date);

  /*! \brief Returns the current month displayed
   *
   * Returns the month (1-12) that is currently displayed.
   */
  int currentMonth() const { return currentMonth_; }

  /*! \brief Returns the current year displayed
   *
   * Returns the year that is currently displayed.
   */
  int currentYear() const { return currentYear_; }

  /*! \brief Clears the current selection.
   *
   * Clears the current selection. Will result in a selection() that is
   * empty().
   */
  void clearSelection();

  /*! \brief Selects a date.
   *
   * Select one date. Both in single or multiple selection mode, this results
   * in a selection() that contains exactly one date.
   */
  void select(const WDate& date);

  /*! \brief Selects multiple dates.
   *
   * Select multiple dates. In multiple selection mode, this results
   * in a selection() that contains exactly the given dates. In single
   * selection mode, at most one date is set.
   */
  void select(const std::set<WDate>& dates);

  /*! \brief Returns the current selection.
   *
   * Returns the set of dates currently selected. In single selection mode,
   * this set contains 0 or 1 dates.
   */
  const std::set<WDate>& selection() const { return selection_; }

  /*! \brief %Signal emitted when the user changes the selection.
   *
   * Emitted after the user has changed the current selection.
   */
  Signal<>& selectionChanged() { return selectionChanged_; }

  /*! \brief %Signal emitted when the user has double clicked on a date.
   *
   * This signal indicates that he user has selected a new date, which 
   * is only available when in single selection mode.
   */
  Signal<WDate>& selected() { return selected_; }

  /*! \brief Configures the calendar to use single click to select.
   *
   * This only applies to a single-selection calendar.
   *
   * \sa setMultipleSelection()
   */
  void setSingleClickSelect(bool single);

  /*! \brief Sets the length for the abbreviated day of week.
   *
   * The \p chars may be 1 or 3, which render "Monday" as
   * respectively "M" or "Mon".
   *
   * The default length is 3.
   */
  void setDayOfWeekLength(int chars);

  /*! \brief Sets the first day of the week.
   *
   * Possible values or 1 to 7, as accepted by WDate::shortDayName().
   *
   * The default value is 1 ("Monday").
   */
  void setFirstDayOfWeek(int dayOfWeek);

protected:
  virtual void render();

private:
  bool              i18n_;
  bool              multipleSelection_;
  bool              singleClickSelect_;
  int               currentYear_;
  int               currentMonth_;
  int               dayOfWeekChars_;
  int               firstDayOfWeek_;
  std::set<WDate>   selection_;
  bool              needRenderMonth_;

  Signal<>          selectionChanged_;
  Signal<WDate>     selected_;

  struct Coordinate {
    int i, j;

    Coordinate() : i(0), j(0) { }
    Coordinate(int x, int y) { i = x; j = y; }
  };

  WTemplate			      *impl_;
  WComboBox                           *monthEdit_;
  WInPlaceEdit                        *yearEdit_;

  WSignalMapper<Coordinate, NoClass>  *cellClickMapper_;
  WSignalMapper<Coordinate, NoClass>  *cellDblClickMapper_;

  void create();
  void renderMonth();

  void monthChanged(int newMonth);
  void yearChanged(WString newYear);
  boost::gregorian::date dateForCell(int week, int dayOfWeek);
  bool isSelected(const WDate& d) const;

  void cellClicked(Coordinate c);

  bool selectInCurrentMonth(const boost::gregorian::date& dt);

  void cellDblClicked(Coordinate c);
};

}

#endif // WCALENDAR_H_
